<?php
namespace AIPM\Policies; use AIPM\Support\Options; class PolicyManager{ public static function get(): array { $o=Options::get(); return $o['policies']??['global'=>['allow'=>[],'block'=>[]],'routes'=>[],'per_post'=>[]]; } public static function merged_for_path(string $path, ?int $post_id=null): array { $p=self::get(); $r=['allow'=>[],'block'=>[]]; foreach(['allow','block'] as $k){ $r[$k]=array_values(array_unique(array_merge($r[$k], $p['global'][$k]??[]))); } foreach(($p['routes']??[]) as $rule){ $pat=str_replace('*','.*',preg_quote($rule['pattern']??'', '/')); if($pat && preg_match('/^'.$pat.'$/i',$path)){ foreach(['allow','block'] as $k){ $r[$k]=array_values(array_unique(array_merge($r[$k], $rule[$k]??[]))); } } } if($post_id && isset($p['per_post'][$post_id])){ foreach(['allow','block'] as $k){ $r[$k]=array_values(array_unique(array_merge($r[$k], $p['per_post'][$post_id][$k]??[]))); } } return $r; } }
